# Copilot Instructions for i4g/proto

1. **Rehydrate** – Re-open `.github/work_routine.md` (same as `planning/persistent_prompt.md`) and skim the newest entries in `planning/change_log.md`. Run `git status -sb` before making edits and stay inside the `i4g` Conda env (`conda run -n i4g ...`). Collaboration is just you + Copilot; you own approvals.
2. **Config Discipline** – Always fetch settings via `i4g.settings.get_settings()`; nested sections (`api`, `storage`, `vector`, `llm`, `identity`, etc.) are mutated by `_apply_environment_overrides`, so override via env vars (`I4G_*`, double underscores) rather than hard-coded paths. Store builders live in `src/i4g/services/factories.py`; use them for structured/review/vector/intake/evidence stores.
3. **Coding Conventions** – New Python code needs full type hints, Google-style docstrings, and ≤120 char lines (Black/isort). Stay ASCII unless the file already depends on Unicode. Never revert user-authored changes without direction. Additional cross-language rules live in `.github/general-coding.instructions.md`.
4. **Core Architecture** – `src/i4g/api/app.py` wires FastAPI routers, middleware (rate limit + TASK_STATUS), and the report-generation lock. `src/i4g/api/review.py` orchestrates search + queue actions backed by `ReviewStore`, `HybridRetriever`, and audit logging via `store.log_action`. Background work executes through `src/i4g/worker/jobs/*` and `src/i4g/worker/tasks.py` (e.g., `generate_report_for_case`).
5. **Developer Loop** – Install editable (`pip install -e .`) so CLI entry points (`i4g-admin`, `i4g-ingest-job`, `i4g-report-job`, `i4g-intake-job`) resolve. Typical cycle: `uvicorn i4g.api.app:app --reload`, `pytest tests/unit`, and targeted demos in `tests/adhoc/` for OCR/extraction/report validation. Regenerate the sandbox with `python scripts/bootstrap_local_sandbox.py --reset` (use `--skip-*` flags for partial rebuilds). Call out if tests were skipped.
6. **Environment Profiles** – `I4G_ENV=local` enforces mock identity + SQLite/Chroma; cloud targets (`i4g-dev`, `i4g-prod`) expect Firestore, Secret Manager, Artifact Registry, and Cloud Run. `Settings._resolve_paths` normalizes relative paths—pass project-relative references instead of manual `Path` math.
7. **Data & Secrets** – Runtime artifacts live in `data/` (SQLite DB, Chroma store, OCR outputs, reports). Delete/refresh them via the bootstrap script rather than custom helpers. Store non-`NEXT_PUBLIC_*` secrets in `.env.local` or platform secret managers.
9. **External Integrations** – The Next.js analyst console calls `/reviews/search`, `/reviews/search/history`, saved-search CRUD endpoints, `/reviews/{id}`, and `/tasks/{task_id}`; keep payloads + audit logging in sync. Report generation uses `i4g/reports` templates plus worker tasks; ensure TASK_STATUS emits progress until Redis replaces the in-memory map. Ingestion enhancements must route through `i4g.ingestion` + `worker/jobs` so CLI and API paths stay aligned.
10. **Repository Roles & Instruction Placement** – This workspace is multi-root. Keep per-repo instruction files in each repo’s `.github/` directory and scope them appropriately:

- `proto/.github/` — primary Python + docs repo. Contains `copilot-instructions.md` (high-level agent runbook), `general-coding.instructions.md` (cross-language norms), `docs.instructions.md` (docs rules), and Python style guidance (Google docstrings, Black/isort, 120-char limit).
- `ui/.github/` — Node.js/Next.js UI repo. Contains `chat-instructions.md` (TypeScript/React rules) and `docs.instructions.md` (UI docs rules and snippet policy).
- `docs/.github/` — documentation-only repo. Contains `docs.instructions.md` focusing on writing quality and snippet guidance.

11. **Docs: code snippets policy** – Do NOT paste entire source files into markdown pages. Instead:

- Include a short, focused snippet (only the lines relevant to the doc).
- Add a repository link pointing to the full file path (e.g., `ui/docker/ui-console.Dockerfile`).
- For large files, include a one-paragraph summary and an inline link to the file rather than embedding the whole file content.

12. **Infrastructure Alignment** – Terraform lives in the sibling `infra/` repo (Workload Identity Federation via `modules/iam/workload_identity_github`). Target `i4g-dev` before `i4g-prod`, impersonate `sa-infra` with `gcloud auth application-default login`, and ensure Cloud Run commands in docs (e.g., `docs/architecture.md`) match reality.
13. **Merge Readiness** – Before requesting merge/approval, run a "picky reviewer" pass: enforce style guides, remove obsolete code, confirm tests/docs across all repos mirror the change, and be ready to summarize any intentionally skipped verifications so reviewers can sign off quickly.
11. **Merge Readiness** – Before requesting merge/approval, run a "picky reviewer" pass: enforce style guides, remove obsolete code, confirm tests/docs across all repos mirror the change, and be ready to summarize any intentionally skipped verifications so reviewers can sign off quickly.
